---
title: "Veri İnceleme"
format:
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    code-fold: false
    df-print: paged
    sidebar: haftalar
---

# 🎯 Amaç {.unnumbered}

-   Bu derste temel amacımız, veri düzenleme ve özetleme tekniklerini uygulamalı olarak öğrenmektir.

-   Özellikle, değişkenler arasındaki ilişkileri incelerken verilerin farklı düzeylerde (toplam vs. alt gruplar) nasıl farklı görünebileceğini keşfedeceğiz.

-   Bu bağlamda Simpson Paradoksu ve verilerin uygun şekilde düzenlenip gruplanmaması durumunda nasıl yanıltıcı sonuçlara ulaşılabileceğini göstermesi açısından güçlü bir örnektir.

-   Anscombe’un Dörtlüsü ise, aynı özet istatistiklere sahip veri setlerinin görselleştirilmeden yanlış yorumlanabileceğini ortaya koyar.

Veri düzenlemenin önemi, sadece “doğru hesaplama” yapmak değil; aynı zamanda hangi değişkenlerin kontrol edilmesi gerektiğini fark ederek daha anlamlı sonuçlar çıkarmaktır.

**🔎 Uygulamalar**

-   Simpson Paradoksu (UCBadmit Örneği)
    -   Genel oranlar ile alt grup oranlarını karşılaştırma
    -   Karıştırıcı (confounding) değişkenlerin etkisini görme
    -   Veri düzenlemenin ve doğru gruplamanın önemini tartışma

<!-- -->

-   Anscombe’un Dörtlüsü
    -   Aynı özet istatistiklere sahip farklı veri setlerini keşfetme
    -   Özet istatistikler (ortalama, sd, korelasyon, regresyon) ile görselleştirme sonuçlarını karşılaştırma
    -   Veriyi görselleştirmeden sadece özet istatistiklere güvenmenin sakıncalarını tartışma
    -   Dersin simspon paradoksu kısmı OpenIntro'nun [Introduction to Modern Statistics](https://openintro.shinyapps.io/ims-01-data-02/#section-simpsons-paradox) bölümünden uyarlanmıştır.

# Simpson Paradoxu

-   Simpson Paradoksu, bir gruptaki iki değişken arasındaki ilişkinin, alt gruplara bölündüğünde ortaya çıktığı, kaybolduğu veya tersine döndüğü istatistiksel bir olgudur.

-   Örneğin, iki değişken bir grupta pozitif ilişkili olabilir, ancak tüm alt gruplarda bağımsız veya hatta negatif ilişkili olabilir.

-   Paradoksu sergileyen vakalar matematik ve olasılık teorisi açısından problemsizdir, ancak yine de birçok insanı şaşırtmaktadır.

-   Bir ilişkiyi incelerken önemli bir değişkeni dikkate almamak **Simpson paradoksu** ile sonuçlanabilir.

-   Simpson paradoksu, açıklayıcı bir değişkenin ihmal edilmesinin, başka bir açıklayıcı değişken ile yanıt değişkeni arasındaki ilişkinin ölçüsü üzerinde yaratabileceği etkiyi göstermektedir.

-   Üçüncü bir değişkenin analize dahil edilmesi, diğer iki değişken arasındaki görünür ilişkiyi değiştirebilir

📦 Örnek Senaryo: Çok Değişkenli İlişkiler

Günlük alınan kalori miktarı ile kalp sağlığı arasındaki ilişkiyi düşündüğümüzde, bu iki değişkenin tek başına incelenmesi yanıltıcı olabilir. Çünkü kişinin yaşı ve fiziksel kondisyonu gibi başka faktörler de bu ilişkiyi etkiler.

👉 Gerçek dünyada değişkenler arasındaki ilişkiler genellikle çok boyutludur ve bu nedenle analizlerde birden fazla değişkeni dikkate almak gerekir.

### Berkeley'deki cinsiyete dayalı kabul oranları:

-   "Berkeley'deki California Üniversitesi'ne 1973 sonbaharında yapılan lisansüstü kabullere ilişkin toplu veriler incelendiğinde, kadın başvuru sahiplerine karşı açık ama yanıltıcı bir önyargı örüntüsü görülmektedir.

-   Veriler altı bölümden gelmektedir. Gizlilik için bölümler A-F olarak kodlanmıştır.

-   Elimizde başvuru sahibinin kadın mı erkek mi olduğu ve kabul edilip edilmediğine dair bilgiler var.

-   İlk olarak, kabul edilen erkeklerin yüzdesinin genel olarak kadınlardan gerçekten daha yüksek olup olmadığını değerlendireceğiz. Daha sonra, her bölüm için aynı yüzdeyi hesaplayacağız.

```{r}
library(dsbox)
library(dplyr)
ucbadmit %>%
  count(gender)

```

```{r}

ucbadmit %>%
  count(dept)

```

```{r}

ucbadmit %>%
  count(admit)
```

Genel cinsiyet dağılımı hakkında ne söyleyebilirsiniz?

> 📌 İpucu: Aşağıdaki olasılıkları hesaplayın: $P(Kabul | Erkek)$ ve $P(Kabul | Kadın)$.

```{r}
ucbadmit %>%
  count(gender, admit)
```

```{r ucbadmit-overall-prop}
ucbadmit %>%
  count(gender, admit) %>%
  group_by(gender) %>%
  mutate(prop_admit = n / sum(n))
```

-   $P(Kabul | Kadın)$ = 0.304
-   $P(Kabul | Erkek)$ = 0.445

```{r}

library(ggplot2)
ggplot(ucbadmit, aes(y = gender, fill = admit)) +
  geom_bar(position = "fill") + 
  labs(title = "Admit by gender",
       y = NULL, x = NULL)
```

-   Departmanlara göre cinsiyet dağılımı hakkında ne söyleyebilirsiniz?

```{r}
ucbadmit %>%
  count(dept, gender, admit)
```

```{r}
library(tidyr)
ucbadmit %>%
  count(dept, gender, admit) %>%
  pivot_wider(names_from = dept, values_from = n)
```

```{r}
ggplot(ucbadmit, aes(y = gender, fill = admit)) +
  geom_bar(position = "fill") +
  facet_wrap(. ~ dept) +
  scale_x_continuous(labels = scales::label_percent()) +
  labs(title = "cinsiyet ve bölümlere göre kabul",
       x = NULL, y = NULL, fill = NULL) +
  theme(legend.position = "bottom")
```

```{r}
ucbadmit %>%
  count(dept, gender, admit) %>%
  group_by(dept, gender) %>%
  mutate(
    n_applied  = sum(n),
    prop_admit = n / n_applied
    ) %>%
  filter(admit == "Admitted") %>%
  rename(n_admitted = n) %>%
  dplyr::select(-admit) %>%
  print(n = 12)
```

Tabloya bakıldığında kadın öğrenciler, üniversitenin en büyük 6 bölümünün 4’ünde erkek öğrencilere göre daha fazla kabul almıştır. Yani A, B, D ve F bölümlerine kabul gören erkek sayısı kadın sayısına göre daha azdır. Şöyle ki erkekler en fazla öğrenci kabul edilen bölüme başvuruyu daha fazla yaparken kız öğrenciler ise en az öğrenci kabul edilen bölüme daha fazla başvuru yapmıştır. Bu sebeple grup yüzdeleri ile toplam yüzdeleri birbirinden farklılık göstermektedir. Konuyu pekiştirmek için başka bir örnekle devam edelim.

🔹 Genel olarak: Erkeklerin kabul edilme olasılığı daha yüksekti.

🔹 Çoğu bölüm içinde: Kadınların kabul edilme olasılığı daha yüksekti.

🔹 Bölüm etkisi kontrol edildiğinde: Cinsiyet ile kabul edilme durumu arasındaki ilişki tersine döndü.

📌 Olası neden:

Kadınlar, kabul oranı daha düşük olan rekabetçi bölümlere başvurma eğilimindeydi.

Erkekler ise, kabul oranı daha yüksek olan daha az rekabetçi bölümlere başvurma eğilimindeydi.

👉 Görüldüğü gibi, erkeklerin genel kabul oranı daha yüksek çıkmış olsa da bölüm bilgisi dikkate alındığında, çoğu bölümde kadınların kabul edilme olasılığı aslında daha yüksektir. Bu durumu Simpson paradoksu olarak adlandırıyoruz.

⚠️ Bu çelişkili bulguyu yalnızca başvurulan bölüm bilgisi analize eklendiğinde keşfedebildik. Bu tür örnekler, bir araştırmada yüzeyde ilgisiz gibi görünen ancak potansiyel olarak karıştırıcı (confounding) etkisi olabilecek değişkenlerin dikkate alınmasının ve toplanmasının önemini vurgular.

**İki değişken arasındaki ilişki**

```{r echo=FALSE, message=FALSE}
df <- tribble(
  ~x, ~y, ~z,
  2,   4,  "A",
  3,   3,  "A",
  4,   2,  "A",
  5,   1,  "A",
  6,   11, "B",
  7,   10, "B",
  8,   9,  "B",
  9,   8,  "B"
)
df
```

```{r echo=FALSE, out.width="100%"}
ggplot(df) +
  geom_point(aes(x = x, y = y), color = "darkgray", size = 5) +
  theme_minimal()
```

```{r echo=FALSE, out.width="100%"}
ggplot(data = df) +
  geom_point(aes(x = x, y = y), color = "darkgray", size = 5) +
  geom_smooth(aes(x = x, y = x), color = "darkgray") +
  theme_minimal()
```

**Üç değişken arasındaki ilişki**

```{r echo=FALSE, out.width="100%"}
ggplot(data = df) +
  geom_point(aes(x = x, y = y, color = z), size = 5) +
  geom_smooth(aes(x = x, y = x), method = "lm", color = "darkgray") +
  theme_minimal()
```

```{r echo=FALSE, out.width="100%"}
ggplot(data = df) +
  geom_point(aes(x = x, y = y, color = z), size = 5) +
  geom_smooth(aes(x = x, y = x), method = "lm", color = "darkgray") +
  geom_smooth(aes(x = x, y = y, color = z), method = "lm") +
  theme_minimal()
```

# Anscombe'un Dörtlüsü

`anscombe_quartet` veri setinin amacı, verilerinizi görselleştirmenin önemli olduğu noktasını vurgulamaya yardımcı olmaktır. Francis Anscombe bu dört veri setini, istatistiksel özet ölçümlerin tek başına iki değişken (burada x ve y) arasındaki tam ilişkiyi yakalayamayacağını göstermek için oluşturmuştur. Anscombe, özet istatistikleri hesaplamadan önce verileri görselleştirmenin önemini vurgulamıştır.

-   Veri seti 1, x ve y arasında doğrusal bir ilişkiye sahiptir
-   Veri Seti 2, x ve y arasında doğrusal olmayan bir ilişki olduğunu göstermektedir
-   Veri seti 3, x ve y arasında tek bir aykırı değer ile doğrusal bir ilişkiye sahiptir
-   Veri seti 4, etkili değer olarak işlev gören tek bir aykırı değer ile x ve y arasında hiçbir ilişki göstermemektedir.

```{r}
library(datasets)
datasets::anscombe
```

-   değişkenlerin ortalamaları

```{r}
library(dplyr)
library(knitr)
colMeans(anscombe) %>% kable(digits=2)
```

-   değişkenlerin standart sapmaları

```{r}
apply(anscombe,2,sd) %>% kable(digits=2)
```

-   değişkenler arası korelasyonlar

```{r}
cor(anscombe[,1:4],anscombe[,5:8]) %>% kable(digits=2)
```

-   regresyon denklemleri

```{r}
ff <- y ~ x
mods <- setNames(as.list(1:4), paste0("lm", 1:4))
for(i in 1:4) {
  ff[2:3] <- lapply(paste0(c("y","x"), i), as.name)
  mods[[i]] <- lmi <- lm(ff, data = anscombe)
  print(anova(lmi))
}
```

```{r}
sapply(mods, coef)
```

-   Özetle
-   $\overline{X}$: 9
-   $sd_{\overline{X}}$: 3.32
-   $\overline{Y}$: 7.5
-   $sd_{\overline{Y}}$: 4.125
-   $cor_{XY}$: 0.816
-   Regresyon denklemleri: $y = 3 + 0.5x$
-   Açıklanan varyans $R^2$ : 0.67

```{r}
library(tidyverse)
library(quartets)

ggplot(anscombe_quartet, aes(x = x, y = y)) +
  geom_point() + 
  geom_smooth(method = "lm", formula = "y ~ x") +
  facet_wrap(~dataset)
```

```{r}
anscombe_quartet |>
  group_by(dataset) |>
  summarise(mean_x = mean(x),
            sd_x = sd(x),
            mean_y = mean(y),
            sd_y = sd(y),
            cor = cor(x, y)) |>
  knitr::kable(digits = 2)
```

-   bu sayfayı da `r emo::ji("link")`[inceleyebilirsiniz.](https://public.tableau.com/app/profile/nir.smilga/viz/AnscombesQuartet_17079175167910/Anscombesquartet)

-   Bunun gibi diğer örnekler için `r emo::ji("link")`[bağlantıyı](https://r-causal.github.io/quartets/) inceleyebilirsiniz.

## 💡 Uygulama Görevi {.unnumbered}

palmerpenguins paketinden penguins veri setini yükleyin.

Veri seti Antarktika’daki penguenlerin türü, ad, boy, ağırlık, yüzgeç uzunluğu, cinsiyet vb.bilgilerini içerir.

-   penguenlerin vücut kitle indeksini (body_mass_g / flipper_length_mm) veri setine ekleyin

-   Bu yeni değişken için türler göre ortalama, standart sapma, minimum ve maksimum değerlerini hesaplayın.

```{r}
#| echo: false
#| 
library(palmerpenguins)
library(dplyr)
library(ggplot2)

data("penguins")

penguins2 <- penguins %>%
  mutate(bmi = body_mass_g / flipper_length_mm)

penguins2 %>%
  group_by(species) %>%
  summarise(mean_bmi = mean(bmi, na.rm = TRUE))

ggplot(penguins2, aes(x = species, y = bmi, fill = species)) +
  geom_boxplot()

```

# 📚 Ödev {.unnumbered}

🔗 Derste yaptıklarımızın tekrarını aşağıdaki iki bölümü tekrarlayınız

🔗 [Language of data](https://openintro.shinyapps.io/ims-01-data-04/)

🔗 [Language of data](https://openintro.shinyapps.io/ims-01-data-02/)
